_updated: 1765838455229
_processing: false
key: backend.server.main
data:
  mjs: >-
    import express from 'express';

    import cors from 'cors';

    import dotenv from 'dotenv';

    import jwt from 'jsonwebtoken';

    import { PGlite } from '@electric-sql/pglite';


    dotenv.config();


    const app = express();

    const port = process.env.PORT || 1337;

    const postgres = new PGlite('./db');


    app.use(cors());

    app.use(express.json());

    app.use(express.urlencoded({ extended: true }));


    // Middleware to authenticate JWT tokens

    const authenticate = async (req, res, next) => {
      try {
        const token = req.headers.authorization?.split(' ')[1];
        if (!token) return res.status(401).json({ error: 'Unauthorized' });

        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.user = decoded;
        next();
      } catch (error) {
        return res.status(401).json({ error: 'Invalid token' });
      }
    };


    // Sign up a new user

    app.post('/api/signup', async (req, res) => {
      try {
        const { button_text } = req.body;
        const { rows } = await postgres.query(
          'INSERT INTO users (button_text) VALUES ($1) RETURNING *',
          [button_text]
        );
        const user = rows[0];
        const token = jwt.sign({ id: user.id }, process.env.JWT_SECRET, {
          expiresIn: '24h',
        });
        res.status(201).json({ user, token });
      } catch (error) {
        res.status(400).json({ error: error.message });
      }
    });


    // Login a user

    app.post('/api/login', async (req, res) => {
      try {
        const { id } = req.body;
        const { rows } = await postgres.query('SELECT * FROM users WHERE id = $1', [
          id,
        ]);
        if (rows.length === 0) {
          return res.status(401).json({ error: 'Invalid credentials' });
        }
        const user = rows[0];
        const token = jwt.sign({ id: user.id }, process.env.JWT_SECRET, {
          expiresIn: '24h',
        });
        res.json({ user, token });
      } catch (error) {
        res.status(400).json({ error: error.message });
      }
    });


    // Handle button click

    app.post('/api/button-click', authenticate, async (req, res) => {
      try {
        const { user_id, device_identifier } = req.body;
        await postgres.query(
          'INSERT INTO analytics (user_id, device_identifier, button_clicks) VALUES ($1, $2, 1) ON CONFLICT (user_id, device_identifier) DO UPDATE SET button_clicks = analytics.button_clicks + 1',
          [user_id, device_identifier]
        );
        res.json({ message: 'Button clicked' });
      } catch (error) {
        res.status(400).json({ error: error.message });
      }
    });


    // Retrieve user's button text

    app.get('/api/button-text', authenticate, async (req, res) => {
      try {
        const { id } = req.user;
        const { rows } = await postgres.query(
          'SELECT button_text FROM users WHERE id = $1',
          [id]
        );
        res.json({ button_text: rows[0].button_text });
      } catch (error) {
        res.status(400).json({ error: error.message });
      }
    });


    // Retrieve user's session information

    app.get('/api/session', authenticate, async (req, res) => {
      try {
        const { id } = req.user;
        const { rows } = await postgres.query(
          'SELECT * FROM sessions WHERE user_id = $1',
          [id]
        );
        res.json(rows);
      } catch (error) {
        res.status(400).json({ error: error.message });
      }
    });


    // Retrieve analytics data

    app.get('/api/analytics', authenticate, async (req, res) => {
      try {
        const { id } = req.user;
        const { rows } = await postgres.query(
          'SELECT * FROM analytics WHERE user_id = $1',
          [id]
        );
        res.json(rows);
      } catch (error) {
        res.status(400).json({ error: error.message });
      }
    });


    app.listen(port, () => {
      console.log(`Server is running on port ${port}`);
    });
  dependencies:
    express: "*"
    cors: "*"
    dotenv: "*"
    jsonwebtoken: "*"
    "@electric-sql/pglite": "*"
  env:
    PORT: "1337"
    JWT_SECRET: your_secret_key
  timestamp: 1765838455169
